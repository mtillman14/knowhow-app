<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - KnowHow</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .notification-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid #e3e6e8;
            background: white;
            transition: background 0.2s;
        }
        .notification-item:hover {
            background: #f8f9f9;
        }
        .notification-item.unread {
            background: #f0f8ff;
            border-left: 3px solid #0077cc;
        }
        .notification-item.unread:hover {
            background: #e6f3ff;
        }
        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background: #0077cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        .notification-text {
            margin-bottom: 4px;
            color: #3b4045;
            line-height: 1.4;
        }
        .notification-text a {
            color: #0077cc;
            text-decoration: none;
            font-weight: 500;
        }
        .notification-text a:hover {
            text-decoration: underline;
        }
        .notification-meta {
            font-size: 12px;
            color: #6a737c;
        }
        .notification-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .notification-actions button {
            background: none;
            border: none;
            color: #6a737c;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .notification-actions button:hover {
            background: #e3e6e8;
            color: #3b4045;
        }
        .notification-type-icon {
            font-size: 14px;
            margin-right: 6px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6a737c;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .mark-all-read {
            background: none;
            border: 1px solid #d6d9dc;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            color: #0077cc;
        }
        .mark-all-read:hover {
            background: #f8f9f9;
        }
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #d32f2f;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <svg viewBox="0 0 32 32" fill="currentColor">
                    <path d="M26 16v10H6V16H4v12h24V16z"/>
                    <path d="M6 10v6h20v-6H6zm18 4H8v-2h16v2z"/>
                    <path d="M6 4v4h20V4H6zm18 2H8V6h16v2z"/>
                </svg>
                KnowHow
            </a>

            <a class="team-selector" id="team-selector" href="#" style="text-decoration: none; color: inherit;">
                <div class="team-icon" id="team-icon">T</div>
                <span id="team-name">Loading...</span>
            </a>

            <div class="header-search">
                <input type="text" placeholder="Search..." id="search-input">
            </div>

            <div class="header-actions">
                <div class="notification-bell" id="notification-bell" title="Notifications">
                    <span class="header-icon">&#128276;</span>
                    <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                </div>
                <button class="btn btn-primary" onclick="window.location.href='questions'">Questions</button>
                <a class="user-menu" id="user-menu" href="#" style="text-decoration: none; color: inherit; cursor: pointer;">
                    <span class="header-icon">&#128100;</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div style="border-bottom: 1px solid #d6d9dc; background: #f8f9f9;">
        <div class="container">
            <div style="display: flex; gap: 0;">
                <a href="#" id="nav-questions" class="nav-tab">Questions</a>
                <a href="#" id="nav-members" class="nav-tab">Members</a>
                <a href="#" id="nav-bookmarks" class="nav-tab">Bookmarks</a>
                <a href="#" id="nav-notifications" class="nav-tab active">Notifications</a>
                <a href="#" id="nav-admin" class="nav-tab" style="display: none;">Admin</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="content">
            <div class="notifications-header">
                <h1>Notifications</h1>
                <button class="mark-all-read" id="mark-all-read" onclick="markAllAsRead()">Mark all as read</button>
            </div>

            <div id="notifications-list">
                <div class="loading">
                    <div class="loading-icon"></div>
                    <p>Loading notifications...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" style="display: none; margin-top: 24px; text-align: center;">
                <button class="btn" id="load-more">Load more</button>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentTeam = null;
        let currentOffset = 0;
        const limit = 20;

        // Get team slug from URL
        const pathParts = window.location.pathname.split('/');
        const teamSlug = pathParts[2];

        async function init() {
            // Check auth
            const user = await KnowHow.checkAuth();
            if (!user) return;

            // Load team info
            await loadTeamInfo();

            // Set profile link
            document.getElementById('user-menu').href = `/team/${teamSlug}/users/${user.user.id}`;
            document.getElementById('notification-bell').onclick = () => {};

            // Load notifications
            await loadNotifications();

            // Setup navigation
            setupNavigation();

            // Setup search
            setupSearch();
        }

        async function setupNavigation() {
            document.getElementById('nav-questions').href = `/team/${teamSlug}/questions`;
            document.getElementById('nav-members').href = `/team/${teamSlug}/members`;
            document.getElementById('nav-bookmarks').href = `/team/${teamSlug}/bookmarks`;
            document.getElementById('nav-notifications').href = `/team/${teamSlug}/notifications`;
            document.getElementById('nav-admin').href = `/team/${teamSlug}/admin`;

            // Check if user is admin to show admin tab
            try {
                const members = await KnowHow.apiCall(`/teams/${teamSlug}/members`);
                const user = await KnowHow.getCurrentUser();
                const currentMember = members.find(m => m.id === user.user.id);
                if (currentMember && currentMember.role === 'admin') {
                    document.getElementById('nav-admin').style.display = 'block';
                }
            } catch (error) {
                console.error('Check admin status error:', error);
            }
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && searchInput.value.trim()) {
                    window.location.href = `/team/${teamSlug}/questions?search=${encodeURIComponent(searchInput.value.trim())}`;
                }
            });
        }

        async function loadTeamInfo() {
            try {
                currentTeam = await KnowHow.apiCall(`/teams/${teamSlug}`);

                document.getElementById('team-name').textContent = currentTeam.name;
                document.getElementById('team-icon').textContent = currentTeam.name[0].toUpperCase();
                document.getElementById('team-selector').href = `/team/${teamSlug}/questions`;
                document.title = `Notifications - ${currentTeam.name}`;
            } catch (error) {
                KnowHow.showNotification('Failed to load team info', 'error');
            }
        }

        async function loadNotifications(append = false) {
            try {
                const data = await KnowHow.apiCall(`/notifications?limit=${limit}&offset=${currentOffset}`);

                const listEl = document.getElementById('notifications-list');

                if (data.notifications.length === 0 && !append) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128276;</div>
                            <h3>No notifications yet</h3>
                            <p>When someone answers your questions, comments on your posts, or upvotes your content, you'll see it here.</p>
                        </div>
                    `;
                    document.getElementById('mark-all-read').style.display = 'none';
                    return;
                }

                const notificationsHtml = data.notifications.map(n => renderNotification(n)).join('');

                if (append) {
                    listEl.innerHTML += notificationsHtml;
                } else {
                    listEl.innerHTML = notificationsHtml;
                }

                // Show/hide load more button
                const pagination = document.getElementById('pagination');
                if (currentOffset + data.notifications.length < data.total) {
                    pagination.style.display = 'block';
                } else {
                    pagination.style.display = 'none';
                }

                // Update unread badge
                updateUnreadBadge();

            } catch (error) {
                console.error('Load notifications error:', error);
                KnowHow.showNotification('Failed to load notifications', 'error');
            }
        }

        function renderNotification(n) {
            const actorName = n.actor_first_name ? `${n.actor_first_name} ${n.actor_last_name}` : 'Someone';
            const actorInitials = n.actor_first_name ?
                (n.actor_first_name[0] + (n.actor_last_name ? n.actor_last_name[0] : '')).toUpperCase() : '?';

            let icon = '';
            let text = '';
            const questionLink = n.team_slug && n.question_id ?
                `/team/${n.team_slug}/questions/${n.question_id}` : '#';

            switch (n.type) {
                case 'answer':
                    icon = '&#128172;';
                    text = `<strong>${actorName}</strong> answered your question <a href="${questionLink}">${escapeHtml(n.question_title || 'a question')}</a>`;
                    break;
                case 'comment':
                    icon = '&#128488;';
                    text = `<strong>${actorName}</strong> commented on <a href="${questionLink}">${escapeHtml(n.question_title || 'your post')}</a>`;
                    break;
                case 'upvote':
                    icon = '&#9650;';
                    text = `<strong>${actorName}</strong> upvoted your ${n.answer_id ? 'answer' : 'question'} on <a href="${questionLink}">${escapeHtml(n.question_title || 'a question')}</a>`;
                    break;
                case 'accepted':
                    icon = '&#10003;';
                    text = `<strong>${actorName}</strong> accepted your answer on <a href="${questionLink}">${escapeHtml(n.question_title || 'a question')}</a>`;
                    break;
                case 'mention':
                    icon = '@';
                    text = `<strong>${actorName}</strong> mentioned you in <a href="${questionLink}">${escapeHtml(n.question_title || 'a question')}</a>`;
                    break;
                default:
                    icon = '&#128276;';
                    text = `You have a notification about <a href="${questionLink}">${escapeHtml(n.question_title || 'a question')}</a>`;
            }

            return `
                <div class="notification-item ${n.is_read ? '' : 'unread'}" data-id="${n.id}">
                    <div class="notification-avatar">${actorInitials}</div>
                    <div class="notification-content">
                        <div class="notification-text">
                            <span class="notification-type-icon">${icon}</span>
                            ${text}
                        </div>
                        <div class="notification-meta">${KnowHow.formatDate(n.created_at)}</div>
                    </div>
                    <div class="notification-actions">
                        ${!n.is_read ? `<button onclick="markAsRead(${n.id})" title="Mark as read">&#10003;</button>` : ''}
                        <button onclick="deleteNotification(${n.id})" title="Delete">&#128465;</button>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function markAsRead(id) {
            try {
                await KnowHow.apiCall(`/notifications/${id}/read`, { method: 'PUT' });

                // Update UI
                const item = document.querySelector(`.notification-item[data-id="${id}"]`);
                if (item) {
                    item.classList.remove('unread');
                    const markReadBtn = item.querySelector('.notification-actions button[title="Mark as read"]');
                    if (markReadBtn) markReadBtn.remove();
                }

                updateUnreadBadge();
            } catch (error) {
                KnowHow.showNotification('Failed to mark as read', 'error');
            }
        }

        async function markAllAsRead() {
            try {
                await KnowHow.apiCall('/notifications/read-all', { method: 'PUT' });

                // Update UI
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const markReadBtn = item.querySelector('.notification-actions button[title="Mark as read"]');
                    if (markReadBtn) markReadBtn.remove();
                });

                updateUnreadBadge();
                KnowHow.showNotification('All notifications marked as read', 'success');
            } catch (error) {
                KnowHow.showNotification('Failed to mark all as read', 'error');
            }
        }

        async function deleteNotification(id) {
            try {
                await KnowHow.apiCall(`/notifications/${id}`, { method: 'DELETE' });

                // Remove from UI
                const item = document.querySelector(`.notification-item[data-id="${id}"]`);
                if (item) {
                    item.remove();
                }

                // Check if list is empty
                const remaining = document.querySelectorAll('.notification-item');
                if (remaining.length === 0) {
                    document.getElementById('notifications-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128276;</div>
                            <h3>No notifications</h3>
                            <p>When someone answers your questions, comments on your posts, or upvotes your content, you'll see it here.</p>
                        </div>
                    `;
                    document.getElementById('mark-all-read').style.display = 'none';
                }

                updateUnreadBadge();
            } catch (error) {
                KnowHow.showNotification('Failed to delete notification', 'error');
            }
        }

        async function updateUnreadBadge() {
            try {
                const data = await KnowHow.apiCall('/notifications/unread/count');
                const badge = document.getElementById('notification-badge');

                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to update unread badge:', error);
            }
        }

        // Load more button
        document.getElementById('load-more').addEventListener('click', () => {
            currentOffset += limit;
            loadNotifications(true);
        });

        init();
    </script>
</body>
</html>
